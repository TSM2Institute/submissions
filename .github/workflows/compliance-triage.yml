name: AI Compliance Triage

on:
  issues:
    types: [opened, reopened]
permissions:
  contents: read
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'submission')
    steps:
      - name: Install jq and gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          echo "gh CLI already available in runner"

      - name: Run Grok Compliance Evaluation
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Build the request payload using jq for proper escaping
          jq -n --arg body "$ISSUE_BODY" '{
            "model": "grok-4",
            "messages": [
              {"role": "system", "content": "You are the TSM2 Institute AI compliance evaluator. Evaluate strictly against the locked Compliance 2.1 8 criteria:\n1. Claim Separation\n2. Definitions\n3. Scaling Consistency\n4. Locality of Measurement\n5. Falsifiability\n6. Evidence Hierarchy\n7. Minimal Ontology\n8. Rhetorical Neutrality\n\nOutput exactly: Markdown table with Criterion | Status (Pass/Fail) | Notes.\nOverall Compliance Outcome: 游릭 Compliant / 游리 Conditional / 游댮 Non-Compliant.\nEducational Commentary section.\nRevision Guidance if needed.\nInstitute Note."},
              {"role": "user", "content": ("Evaluate this submission strictly and neutrally:\n\n" + $body)}
            ],
            "temperature": 0.2,
            "max_tokens": 2048
          }' > request.json
          
          curl https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $GROK_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json > response.json

          # Extract AI response
          COMMENT=$(jq -r '.choices[0].message.content // "Error: No response"' response.json)

          # Post scorecard comment
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT" --repo ${{ github.repository }}

          # Auto-label based on outcome emoji
          if echo "$COMMENT" | grep -q "游릭"; then
            gh issue edit ${{ github.event.issue.number }} --add-label "compliance-cleared" --remove-label "needs-triage" --repo ${{ github.repository }}
          elif echo "$COMMENT" | grep -q "游리"; then
            gh issue edit ${{ github.event.issue.number }} --add-label "conditional" --remove-label "needs-triage" --repo ${{ github.repository }}
          else
            gh issue edit ${{ github.event.issue.number }} --add-label "non-compliant" --remove-label "needs-triage" --repo ${{ github.repository }}
          fi
